<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>CSV Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="/static/styles.css" />
</head>

<body>
  <h1>CSV Search</h1>
  <p><a href="/upload">Upload CSV</a> | <a href="/conversations">Conversations</a> | <a href="/monthly">Messages Per Month</a></p>
  <div id="search-controls">
    <div id="search-terms">
      <input class="term" placeholder="Search text" list="tag-suggestions" />
    </div>
    <button id="add-term">Add Term</button>
    <select id="operator">
      <option value="AND">AND</option>
      <option value="OR">OR</option>
    </select>
    <label>Start: <input type="date" id="start-date" /></label>
    <label>End: <input type="date" id="end-date" /></label>
    <button id="search-btn" onclick="doSearch()">Search</button>
    <span id="status"></span>
  </div>
  <datalist id="tag-suggestions"></datalist>
  <table id="results"></table>
  <div id="side-panel">
    <h3>Word Cloud</h3>
    <div id="wordcloud"></div>
    <p><a href="#" id="generate-wordcloud">Generate Word Cloud</a></p>
  </div>
  <script>
    let currentGroups = [];
    let currentTerms = [];

    function formatDateTime(dateString) {
      const d = new Date(dateString);
      const datePart = d.toLocaleDateString(undefined, {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      let hours = d.getHours();
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12;
      const timePart = `${String(hours).padStart(2, '0')}:${minutes} ${ampm}`;
      return `${datePart} ${timePart}`;
    }

    function attachTagSuggestions(input) {
      input.setAttribute('list', 'tag-suggestions');
      input.addEventListener('focus', () => {
        // Trigger showing options when the field is focused
        input.dispatchEvent(new Event('input'));
      });
    }

    function setControlsHeight() {
      const sc = document.getElementById('search-controls');
      document.documentElement.style.setProperty('--controls-height', sc.offsetHeight + 'px');
    }
    setControlsHeight();
    window.addEventListener('resize', setControlsHeight);

    // Apply tag suggestions to the initial search term input
    attachTagSuggestions(document.querySelector('#search-terms .term'));

    document.getElementById('add-term').addEventListener('click', () => {
      const container = document.getElementById('search-terms');
      const input = document.createElement('input');
      input.className = 'term';
      input.placeholder = 'Search text';
      attachTagSuggestions(input);
      container.appendChild(document.createTextNode(' '));
      container.appendChild(input);
      setControlsHeight();
    });

    function createRow(row, isMatch = false) {
      const tr = document.createElement('tr');
      if (isMatch) {
        tr.classList.add('match');
      }
      ['Text', 'Tags'].forEach(key => {
        const td = document.createElement('td');
        if (key === 'Text') {
          const wrapper = document.createElement('div');
          const sender = (row.Sender || '').trim().toLowerCase();
          const senderClass = sender.includes('chris') ? 'chris' : 'hayley';
          wrapper.classList.add('message', senderClass);
          const timeDiv = document.createElement('div');
          timeDiv.className = 'time';
          timeDiv.textContent = formatDateTime(row.Date) + ' ';
          const link = document.createElement('a');
          link.href = `?id=${row.id}`;
          link.textContent = '(Permalink)';
          timeDiv.appendChild(link);
          const textDiv = document.createElement('div');
          textDiv.className = 'text';
          if (currentTerms.length) {
            const regex = new RegExp('(' + currentTerms.map(t => t.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')).join('|') + ')', 'gi');
            textDiv.innerHTML = row[key].replace(regex, '<mark>$1</mark>');
          } else {
            textDiv.textContent = row[key];
          }
          wrapper.appendChild(timeDiv);
          wrapper.appendChild(textDiv);
          td.appendChild(wrapper);
        } else if (key === 'Tags') {
          const container = document.createElement('div');
          container.className = 'tags';
          (row.tags || []).forEach(t => {
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = t;
            span.addEventListener('click', () => searchByTag(t));
            container.appendChild(span);
          });
          const input = document.createElement('input');
          input.className = 'tag-input';
          input.setAttribute('list', 'tag-suggestions');
          const btn = document.createElement('button');
          btn.textContent = 'Add Tag';
          btn.addEventListener('click', async () => {
            const tag = input.value.trim();
            if (!tag) return;
            await fetch(`/messages/${row.id}/tags`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tag })
            });
            const span = document.createElement('span');
            span.className = 'tag';
            span.textContent = tag;
            span.addEventListener('click', () => searchByTag(tag));
            container.appendChild(span);
            input.value = '';
            loadTags();
          });
          td.appendChild(container);
          td.appendChild(input);
          td.appendChild(btn);
        }
        tr.appendChild(td);
      });
      return tr;
    }

    function renderResults(data) {
      const table = document.getElementById('results');
      table.innerHTML = '';
      if (!data.groups.length) {
        table.innerHTML = '<tr><td colspan="2">No results found</td></tr>';
        return;
      }
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      ['Text', 'Tags'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);
      currentGroups = data.groups;
      data.groups.forEach((group, idx) => {
        const tbody = document.createElement('tbody');
        tbody.dataset.group = idx;
        tbody.classList.add('group');
        const topRow = document.createElement('tr');
        const topTd = document.createElement('td');
        topTd.colSpan = 2;
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Load Previous 5';
        prevBtn.addEventListener('click', () => loadMore(idx, -5));
        topTd.appendChild(prevBtn);
        topRow.appendChild(topTd);
        tbody.appendChild(topRow);
        group.rows.forEach((row, i) => {
          const tr = createRow(row, group.match_indices.includes(i));
          tbody.appendChild(tr);
        });
        const bottomRow = document.createElement('tr');
        const bottomTd = document.createElement('td');
        bottomTd.colSpan = 2;
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Load Next 5';
        nextBtn.addEventListener('click', () => loadMore(idx, 5));
        bottomTd.appendChild(nextBtn);
        bottomRow.appendChild(bottomTd);
        tbody.appendChild(bottomRow);
        table.appendChild(tbody);
      });
    }

    async function doSearch() {
      const status = document.getElementById('status');
      const btn = document.getElementById('search-btn');
      const terms = Array.from(document.querySelectorAll('#search-terms .term'))
        .map(i => i.value.trim())
        .filter(v => v);
      if (!terms.length) {
        status.textContent = 'Please enter a search term';
        return;
      }
      currentTerms = terms;
      const operator = document.getElementById('operator').value;
      const start = document.getElementById('start-date').value;
      const end = document.getElementById('end-date').value;
      const params = new URLSearchParams();
      terms.forEach(t => params.append('terms', t));
      params.append('operator', operator);
      if (start) params.append('start', start);
      if (end) params.append('end', end);
      status.textContent = 'Searching...';
      btn.disabled = true;
      const res = await fetch('/search?' + params.toString());
      const data = await res.json();
      status.textContent = '';
      btn.disabled = false;
      renderResults(data);
    }

    async function searchByTag(tag) {
      const status = document.getElementById('status');
      status.textContent = 'Searching...';
      const res = await fetch('/search_tag?tag=' + encodeURIComponent(tag));
      const data = await res.json();
      status.textContent = '';
      currentTerms = [tag];
      renderResults(data);
    }

    async function loadMore(idx, delta) {
      const group = currentGroups[idx];
      let startId;
      if (delta < 0) {
        startId = group.start + 1 + delta;
        if (startId < 1) startId = 1;
      } else {
        startId = group.end + 2;
      }
      const res = await fetch(`/messages?start=${startId}&count=${Math.abs(delta)}`);
      const data = await res.json();
      if (!data.rows.length) return;
      const tbody = document.querySelector(`tbody[data-group="${idx}"]`);
      if (delta < 0) {
        const reference = tbody.children[1];
        data.rows.forEach((row) => {
          const tr = createRow(row);
          tbody.insertBefore(tr, reference);
        });
        group.start -= data.rows.length;
      } else {
        const reference = tbody.lastElementChild;
        data.rows.forEach((row) => {
          const tr = createRow(row);
          tbody.insertBefore(tr, reference);
        });
        group.end += data.rows.length;
      }
    }

    async function loadWordCloud() {
      const res = await fetch('/wordcloud');
      const data = await res.json();
      const container = document.getElementById('wordcloud');
      container.innerHTML = '';
      if (data.words) {
        const entries = Object.entries(data.words);
        if (entries.length) {
          const max = Math.max(...entries.map(e => e[1]));
          entries.forEach(([word, count]) => {
            const a = document.createElement('a');
            a.href = '#';
            a.textContent = word;
            const size = 10 + (count / max) * 20;
            a.style.fontSize = size + 'px';
            a.addEventListener('click', (ev) => {
              ev.preventDefault();
              document.querySelector('#search-terms .term').value = word;
              doSearch();
            });
            container.appendChild(a);
            container.appendChild(document.createTextNode(' '));
          });
        }
      }
    }

    async function loadTags() {
      const res = await fetch('/tags');
      const data = await res.json();
      const dl = document.getElementById('tag-suggestions');
      dl.innerHTML = '';
      data.tags.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        dl.appendChild(opt);
      });
    }

    document.getElementById('generate-wordcloud').addEventListener('click', async (e) => {
      e.preventDefault();
      await fetch('/generate_wordcloud', { method: 'POST' });
      loadWordCloud();
    });

    loadWordCloud();
    loadTags();
    const params = new URLSearchParams(window.location.search);
    const msgId = params.get('id');
    if (msgId) {
      fetch(`/message/${msgId}`).then(r => r.json()).then(data => {
        currentTerms = [];
        renderResults(data);
      });
    }
  </script>
</body>

</html>
